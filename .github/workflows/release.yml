# .github/workflows/release.yml
name: Release â€¢ bundled artifacts

on:
  workflow_run:
    workflows: ["Build - Windows"]     # add more build workflows here later
    types: [completed]

jobs:
  gather-and-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    # â”€â”€ 1. (NEW) Dump all artifacts for this run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: List artifacts in the triggering run
      uses: actions/github-script@v7
      with:
        script: |
          const runId = ${{ github.event.workflow_run.id }};
          const { data } = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo:  context.repo.repo,
            run_id: runId,
            per_page: 100
          });

          console.log(`Artifacts for workflow-run ${runId}:`);
          if (data.artifacts.length === 0) {
            console.log('  â›”ï¸  (none found)');
          } else {
            for (const a of data.artifacts) {
              console.log(`  â€¢ ${a.name}  (id:${a.id}, size: ${(a.size_in_bytes/1_048_576).toFixed(1)} MiB, expired: ${a.expired})`);
            }
          }

    # â”€â”€ 2. Download the build artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Download build artifacts
      id: download_artifact
      uses: actions/download-artifact@v4
      with:
        # use a pattern so it will match â€œwindows-buildâ€, â€œlinux-buildâ€ â€¦ later
        pattern: "*-build"
        run-id: ${{ github.event.workflow_run.id }}
        path:   dist
        merge-multiple: true
        repository: ${{ github.repository }}

    # â”€â”€ 3. Ensure something actually arrived â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Ensure artifacts exist
      run: |
        if [[ ! -d dist || -z "$(ls -A dist)" ]]; then
          echo "No *-build artifacts found for run ${{ github.event.workflow_run.id }}."
          echo "ðŸ‘‰ Check the artifact list above â€“ is the name different or missing?"
          exit 1
        fi
        echo "Contents of dist/ after download:"
        tree -L 2 dist || true

    # â”€â”€ 4. Decide whether this is a prerelease or a tagged release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Decide tag
      id: tag
      run: |
        if [[ "${{ github.event.workflow_run.head_branch }}" =~ ^v[0-9] ]]; then
          echo "tag=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "prerelease=false" >> $GITHUB_OUTPUT
        else
          echo "tag=nightly-${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "prerelease=true"  >> $GITHUB_OUTPUT
        fi

    # â”€â”€ 5. Create / update the GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Create / Update GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name:  ${{ steps.tag.outputs.tag }}
        name:      ${{ steps.tag.outputs.tag }}
        prerelease: ${{ steps.tag.outputs.prerelease }}
        draft: false
        body: |
          Automated build from commit ${{ github.event.workflow_run.head_sha }}.

          Artifacts:
          ${{ join(fromJson(steps.download_artifact.outputs.artifacts).*, ', ') }}
        files: dist/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
