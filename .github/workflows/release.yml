name: Release • bundled artifacts

on:
  workflow_run:
    workflows: ["Build - Windows"]      # add more build workflows later
    types: [completed]

# ── the token MUST be allowed to read artifacts from other runs ──────────────
permissions:
  actions: read       # <- crucial
  contents: write     # the GH-Release step still needs this

jobs:
  gather-and-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # ── Download the build artifact(s) from the completed Windows run ─────
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build                 # exact artifact name
          run-id: ${{ github.event.workflow_run.id }}
          path: dist                          # everything lands in ./dist

      # ── Sanity-check ──────────────────────────────────────────────────────
      - name: Ensure artifacts exist
        run: |
          if [[ ! -d dist || -z "$(ls -A dist)" ]]; then
            echo "No windows-build artifact found for run ${{ github.event.workflow_run.id }}."
            exit 1
          fi
          tree -L 2 dist

      # ── Decide tag name (nightly vs semver) ───────────────────────────────
      - name: Decide tag
        id: tag
        run: |
          if [[ "${{ github.event.workflow_run.head_branch }}" =~ ^v[0-9] ]]; then
            echo "tag=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "tag=nightly-${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "prerelease=true"  >> $GITHUB_OUTPUT
          fi

      # ── Publish (or update) the GitHub Release ───────────────────────────
      - name: Create / Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name:   ${{ steps.tag.outputs.tag }}
          name:       ${{ steps.tag.outputs.tag }}
          prerelease: ${{ steps.tag.outputs.prerelease }}
          draft: false
          body: |
            Automated build from commit ${{ github.event.workflow_run.head_sha }}.
            Artifact: windows-build
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
