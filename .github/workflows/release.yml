# .github/workflows/release.yml
name: Release â€¢ bundled artifacts

on:
  workflow_run:
    workflows: ["Build - Windows"]       # add more build workflows here later
    types: [completed]

jobs:
  gather-and-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "*-build"                # QUOTED so YAML treats it as a string
        run-id: ${{ github.event.workflow_run.id }}
        path: dist
        merge-multiple: true

    - name: Ensure artifacts exist
      run: |
        if [ -z "$(ls -A dist)" ]; then
          echo "No *-build artifacts found for run ${{ github.event.workflow_run.id }}."
          exit 1
        fi

    - name: Decide tag
      id: tag
      run: |
        if [[ "${{ github.event.workflow_run.head_branch }}" =~ ^v[0-9] ]]; then
          echo "tag=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "prerelease=false" >> $GITHUB_OUTPUT
        else
          echo "tag=nightly-${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "prerelease=true"  >> $GITHUB_OUTPUT
        fi

    - name: Create / Update GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name:  ${{ steps.tag.outputs.tag }}
        name:      ${{ steps.tag.outputs.tag }}
        prerelease: ${{ steps.tag.outputs.prerelease }}
        draft: false
        body: |
          Automated build from commit ${{ github.event.workflow_run.head_sha }}.
          Artifacts:
          ${{ join(fromJson(steps.download-artifact.outputs.artifacts).*, ', ') }}
        files: dist/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
