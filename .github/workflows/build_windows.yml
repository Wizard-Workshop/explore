# .github/workflows/windows_build.yml
name: Build - Windows
on:
  push:    {branches: [main], tags: ["v*"]}

env:
  GODOT_VER: 4.4.1-stable
  PRESET:    "Windows Desktop"

jobs:
  win-build:
    runs-on: windows-latest
    steps:

    # ── Checkout + cache (unchanged) ──────────────────────────
    - uses: actions/checkout@v4
      with: {submodules: recursive}

    - uses: actions/cache@v4
      id: godot-cache
      with:
        path: |
          C:\godot
          ~\AppData\Roaming\Godot\export_templates   # linter stays quiet
        key: godot-win-${{ env.GODOT_VER }}-v1

    - name: Install Godot editor + templates (if cache missed)
      if: steps.godot-cache.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        $base = "https://github.com/godotengine/godot/releases/download/${env:GODOT_VER}"
        Invoke-WebRequest "$base/Godot_v${env:GODOT_VER}_win64.exe.zip" -OutFile godot.zip
        Expand-Archive godot.zip -DestinationPath C:\godot
        Invoke-WebRequest "$base/Godot_v${env:GODOT_VER}_export_templates.tpz" -OutFile tpl.tpz
        Expand-Archive tpl.tpz -DestinationPath "$env:APPDATA\Godot\export_templates"

    # ── rcedit in one line (Chocolatey) ───────────────────────
    - name: Install rcedit
      run: choco install rcedit --yes

    # ── Export and validate ──────────────────────────────────
    - name: Export Windows Desktop
      shell: pwsh
      run: |
        mkdir -Force build\windows
        & "C:\godot\Godot_v${env:GODOT_VER}_win64.exe" --headless `
          --export-release "${env:PRESET}" "build/windows/Explore.exe"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "❌ Godot export failed (exit $LASTEXITCODE)"
          exit $LASTEXITCODE
        }
        if (-not (Test-Path "build/windows/Explore.exe")) {
          Write-Error "❌ Godot did not produce Explore.exe"
          exit 1
        }

    # ── Upload artifact ──────────────────────────────────────
    - uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/windows
